use serde_json::Value;

mod base_driver;
use base_driver::{BaseDriver, ProblemDriver, TestCase};

mod solution;
use solution::range_max_subset_xor;

pub struct XorBasisRangeQueriesDriver;

impl ProblemDriver for XorBasisRangeQueriesDriver {
    fn parse_test_cases(&self, input: &Value, expected_output: &Value) -> Vec<TestCase> {
        let input_array = input.as_array().expect("Input should be an array");
        let expected_array = expected_output.as_array().expect("Expected output should be an array");

        input_array
            .iter()
            .enumerate()
            .map(|(i, test_input)| TestCase {
                input: test_input.clone(),
                expected_output: expected_array[i].clone(),
            })
            .collect()
    }

    fn execute_test_case(&self, test_case: &TestCase, _index: usize) -> Result<Value, Box<dyn std::error::Error>> {
        let arr = test_case
            .input
            .as_array()
            .ok_or("Test case input must be [nums, queries]")?;

        if arr.len() != 2 {
            return Err("Test case input must be [nums, queries]".into());
        }

        let nums_val = arr[0].as_array().ok_or("nums must be an array")?;
        let nums: Vec<i64> = nums_val
            .iter()
            .map(|v| v.as_i64().ok_or("nums elements must be integers"))
            .collect::<Result<Vec<i64>, _>>()?;

        let queries_val = arr[1].as_array().ok_or("queries must be an array")?;
        let queries: Vec<Vec<i64>> = queries_val
            .iter()
            .map(|q| {
                q.as_array()
                    .ok_or("each query must be an array")?
                    .iter()
                    .map(|x| x.as_i64().ok_or("query elements must be integers"))
                    .collect::<Result<Vec<i64>, _>>()
            })
            .collect::<Result<Vec<Vec<i64>>, _>>()?;

        let result = range_max_subset_xor(nums, queries);
        Ok(serde_json::json!(result))
    }

    fn compare_results(&self, actual: &Value, expected: &Value) -> bool {
        actual == expected
    }
}

fn main() {
    let driver = BaseDriver::new(XorBasisRangeQueriesDriver);
    driver.run();
}
